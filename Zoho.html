<html>
<meta http-equiv="Cache-Control" content="no-store"/>
<head>
    <title>Zoho leads extractor</title>
    <script src="https://connectors.tableau.com/libs/tableauwdc-1.1.1.js" type="text/javascript"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        (function(){

            var myConnector = tableau.makeConnector();

            myConnector.getColumnHeaders = function() {
                var fieldNames = ['LEADID', 'SMOWNERID', 'Lead Owner','Company', 'First Name' ,'Last Name', 'Email',  'Phone',  'No of Employees', 'Annual Revenue', 'SMCREATORID', 'Created By', 'MODIFIEDBY', 'Modified By', 'Created Time', 'Modified Time', 'Country', 'Email Opt Out', 'Last Activity Time','Contact Permission Granted'];
                var fieldTypes = ['string', 'string'   , 'string'    ,'string' , 'string'     ,'string'   , 'string', 'string', 'int'            , 'float'         , 'string'     , 'string',     'string'    , 'string',      'datetime',     'datetime',      'string',  'string',        'datetime',          'bool'];
                tableau.headersCallback(fieldNames, fieldTypes)
            }

            myConnector.getTableData = function(lastRecordToken) {
                var dataToReturn = [];
                var hasMoreData = false;
                var xhr = $.ajax({
                    url: 'http://localhost:3000/proxy?url=http://crm.zoho.com:80/crm/private/json/Leads/getRecords?authtoken=fe9fffcfec31f231a27ebb598f171688&scope=crmapi',
                    datatype: 'json',
                    success: function(data){

                        if(data.response.result.Leads.row){

                            var leads = data.response.result.Leads.row;

                            for(var i=0;i<leads.length;i++) {

                                var row = leads[i].FL;
                                var lead = {};

                                for (var j = 0; j < row.length; j++) {
                                    lead[row[j]["val"]] = row[j]["content"];
                                }

                                dataToReturn.push(lead);
                            }

                            tableau.dataCallback(dataToReturn, lastRecordToken, false)
                        }else{
                            tableau.abortWithError("No leads found in Zoho");
                        }


                    },
                    error: function(xhr, ajaxOptions, thrownError){
                        // If the connection fails, log the error and return an empty set.
                        tableau.log("Connection error: " + xhr.responseText + "\n" + thrownError);
                        tableau.abortWithError("Error while trying to connect to Zoho.");
                    }
                });
            }
            tableau.registerConnector(myConnector);
        })();

        $(document).ready(function(){
            $("#submitButton").click(function(){

                tableau.connectionName = " leads";
                tableau.submit();

            });
        });
    </script>
</head>
<body>
<p><button type="button" id="submitButton">Get the Data</button></p>
</body>

</html>